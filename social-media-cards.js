const socialMediaPlatforms = [
    { 
        name: 'Instagram', 
        logo: 'blog/assets/img/instagram-logo.png',
        services: {
            Seguidores: [
                { quantity: 100, price: 7.60 },
                { quantity: 500, price: 27.20 },
                { quantity: 1000, price: 52.50 },
                { quantity: 5000, price: 252.20 },
            ],
            Curtidas: [
                { quantity: 100, price: 3.90 },
                { quantity: 500, price: 15.20 },
                { quantity: 1000, price: 22.50 },
                { quantity: 5000, price: 92.20 },
            ],
            Visualizações: [
                { quantity: 100, price: 4.20 },
                { quantity: 500, price: 15.90 },
                { quantity: 1000, price: 27.50 },
                { quantity: 5000, price: 132.40 },
            ],
            Comentários: [
                { quantity: 10, price: 5.00 },
                { quantity: 50, price: 20.00 },
                { quantity: 100, price: 35.00 },
                { quantity: 500, price: 150.00 },
            ],
        }
    },
    { 
        name: 'Facebook', 
        logo: 'blog/assets/img/facebook-logo.png',
        services: {
            Seguidores: [
                { quantity: 100, price: 6.80 },
                { quantity: 500, price: 25.50 },
                { quantity: 1000, price: 48.00 },
                { quantity: 5000, price: 230.00 },
            ],
            Curtidas: [
                { quantity: 100, price: 3.50 },
                { quantity: 500, price: 14.00 },
                { quantity: 1000, price: 20.00 },
                { quantity: 5000, price: 85.00 },
            ],
            Visualizações: [
                { quantity: 100, price: 3.80 },
                { quantity: 500, price: 14.50 },
                { quantity: 1000, price: 25.00 },
                { quantity: 5000, price: 120.00 },
            ],
            Comentários: [
                { quantity: 10, price: 4.50 },
                { quantity: 50, price: 18.00 },
                { quantity: 100, price: 32.00 },
                { quantity: 500, price: 140.00 },
            ],
        }
    },
    { 
        name: 'TikTok', 
        logo: 'blog/assets/img/tiktok-logo.png',
        services: {
            Seguidores: [
                { quantity: 100, price: 8.20 },
                { quantity: 500, price: 30.00 },
                { quantity: 1000, price: 57.00 },
                { quantity: 5000, price: 275.00 },
            ],
            Curtidas: [
                { quantity: 100, price: 4.20 },
                { quantity: 500, price: 16.50 },
                { quantity: 1000, price: 24.00 },
                { quantity: 5000, price: 100.00 },
            ],
            Visualizações: [
                { quantity: 100, price: 4.50 },
                { quantity: 500, price: 17.00 },
                { quantity: 1000, price: 30.00 },
                { quantity: 5000, price: 145.00 },
            ],
            Comentários: [
                { quantity: 10, price: 5.50 },
                { quantity: 50, price: 22.00 },
                { quantity: 100, price: 38.00 },
                { quantity: 500, price: 165.00 },
            ],
        }
    },
    { 
        name: 'Kwai', 
        logo: 'blog/assets/img/kwai-logo.png',
        services: {
            Seguidores: [
                { quantity: 100, price: 7.00 },
                { quantity: 500, price: 26.00 },
                { quantity: 1000, price: 50.00 },
                { quantity: 5000, price: 240.00 },
            ],
            Curtidas: [
                { quantity: 100, price: 3.70 },
                { quantity: 500, price: 14.50 },
                { quantity: 1000, price: 21.00 },
                { quantity: 5000, price: 88.00 },
            ],
            Visualizações: [
                { quantity: 100, price: 4.00 },
                { quantity: 500, price: 15.00 },
                { quantity: 1000, price: 26.00 },
                { quantity: 5000, price: 125.00 },
            ],
            Comentários: [
                { quantity: 10, price: 4.80 },
                { quantity: 50, price: 19.00 },
                { quantity: 100, price: 33.00 },
                { quantity: 500, price: 145.00 },
            ],
        }
    },
    { 
        name: 'YouTube', 
        logo: 'blog/assets/img/youtube-logo.png',
        services: {
            Inscritos: [
                { quantity: 100, price: 9.00 },
                { quantity: 500, price: 35.00 },
                { quantity: 1000, price: 65.00 },
                { quantity: 5000, price: 300.00 },
            ],
            Curtidas: [
                { quantity: 100, price: 4.50 },
                { quantity: 500, price: 18.00 },
                { quantity: 1000, price: 26.00 },
                { quantity: 5000, price: 110.00 },
            ],
            Visualizações: [
                { quantity: 100, price: 5.00 },
                { quantity: 500, price: 20.00 },
                { quantity: 1000, price: 35.00 },
                { quantity: 5000, price: 160.00 },
            ],
            Comentários: [
                { quantity: 10, price: 6.00 },
                { quantity: 50, price: 25.00 },
                { quantity: 100, price: 45.00 },
                { quantity: 500, price: 200.00 },
            ],
        }
    },
    { 
        name: 'Twitter', 
        logo: 'blog/assets/img/twitter-logo.png',
        services: {
            Seguidores: [
                { quantity: 100, price: 7.20 },
                { quantity: 500, price: 28.00 },
                { quantity: 1000, price: 54.00 },
                { quantity: 5000, price: 260.00 },
            ],
            Curtidas: [
                { quantity: 100, price: 3.80 },
                { quantity: 500, price: 15.00 },
                { quantity: 1000, price: 23.00 },
                { quantity: 5000, price: 95.00 },
            ],
            Retweets: [
                { quantity: 100, price: 4.30 },
                { quantity: 500, price: 16.50 },
                { quantity: 1000, price: 29.00 },
                { quantity: 5000, price: 140.00 },
            ],
            Comentários: [
                { quantity: 10, price: 5.20 },
                { quantity: 50, price: 21.00 },
                { quantity: 100, price: 36.00 },
                { quantity: 500, price: 155.00 },
            ],
        }
    },
 ];
 
 let cart = [];

 function createCard(platform) {
     const card = document.createElement('div');
     card.className = 'service-card';
     card.innerHTML = `
         <div class="card-header">
             <h3>${platform.name}</h3>
             <img src="${platform.logo}" alt="${platform.name} logo" class="platform-logo">
         </div>
         <select class="service-select">
             <option value="">Selecione um serviço</option>
             ${Object.keys(platform.services).map(service => `<option value="${service}">${service}</option>`).join('')}
         </select>
         <div class="price-table"></div>
         <div class="quantity-selector" style="display: none;">
             <label for="quantity">Quantidade:</label>
             <input type="number" id="quantity" name="quantity" min="1" required>
         </div>
         <button class="add-to-cart-button" style="display: none;">Adicionar ao Carrinho</button>
     `;
 
     const serviceSelect = card.querySelector('.service-select');
     const priceTable = card.querySelector('.price-table');
     const quantitySelector = card.querySelector('.quantity-selector');
     const addToCartButton = card.querySelector('.add-to-cart-button');
 
     serviceSelect.addEventListener('change', (e) => {
         const selectedService = e.target.value;
         if (selectedService) {
             priceTable.innerHTML = `
                 <table>
                     <tr>
                         <th>Quantidade</th>
                         <th>Preço (R$)</th>
                     </tr>
                     ${platform.services[selectedService].map(row => `
                         <tr>
                             <td>${row.quantity}</td>
                             <td>${row.price.toFixed(2)}</td>
                         </tr>
                     `).join('')}
                 </table>
             `;
             quantitySelector.style.display = 'block';
             addToCartButton.style.display = 'block';
         } else {
             priceTable.innerHTML = '';
             quantitySelector.style.display = 'none';
             addToCartButton.style.display = 'none';
         }
     });
 
     addToCartButton.addEventListener('click', () => {
         const selectedService = serviceSelect.value;
         const quantity = parseInt(quantitySelector.querySelector('#quantity').value);
         if (selectedService && quantity > 0) {
             const priceInfo = platform.services[selectedService].find(p => p.quantity <= quantity);
             if (priceInfo) {
                 const totalPrice = (quantity / priceInfo.quantity) * priceInfo.price;
                 addToCart(platform.name, selectedService, quantity, totalPrice);
             } else {
                 alert('Quantidade inválida para o serviço selecionado.');
             }
         } else {
             alert('Por favor, selecione um serviço e uma quantidade válida.');
         }
     });
 
     return card;
 }
 
 function addToCart(platform, service, quantity, price) {
     const existingItem = cart.find(item => item.platform === platform && item.service === service);
     if (existingItem) {
         existingItem.quantity += quantity;
         existingItem.price += price;
     } else {
         cart.push({ platform, service, quantity, price });
     }
     updateCartDisplay();
     alert('Item adicionado ao carrinho!');
 }
 
 function updateCartDisplay() {
     const cartContainer = document.getElementById('cart-items');
     const cartTotal = document.getElementById('cart-total');
     let totalAmount = 0;
 
     cartContainer.innerHTML = '';
     cart.forEach((item, index) => {
         const li = document.createElement('li');
         li.innerHTML = `
             ${item.platform} - ${item.service}: ${item.quantity} unidades - R$ ${item.price.toFixed(2)}
             <button onclick="removeFromCart(${index})">Remover</button>
         `;
         cartContainer.appendChild(li);
         totalAmount += item.price;
     });
 
     cartTotal.textContent = `Total: R$ ${totalAmount.toFixed(2)}`;
 }
 
 function removeFromCart(index) {
     cart.splice(index, 1);
     updateCartDisplay();
 }
 
 function openCheckoutModal() {
     if (cart.length === 0) {
         alert('Seu carrinho está vazio.');
         return;
     }
 
     const modal = document.getElementById('checkout-modal');
     modal.style.display = 'block';
 }
 
 function closeCheckoutModal() {
     const modal = document.getElementById('checkout-modal');
     modal.style.display = 'none';
 }
 
 function clearCheckoutForm() {
     document.getElementById('customer-name').value = '';
     document.getElementById('customer-email').value = '';
     document.getElementById('customer-phone').value = '';
     document.getElementById('customer-instagram').value = '';
     document.getElementById('customer-notes').value = '';
 }
 
 function showOrderModal() {
    const modal = document.getElementById('order-modal');
    const spinner = document.getElementById('order-loading-spinner');
    const responseMessage = document.getElementById('order-response-message');
    const okButton = document.getElementById('order-ok-button');

    modal.style.display = 'block';
    spinner.style.display = 'block';
    responseMessage.textContent = '';
    okButton.style.display = 'none';

    // Remove the WhatsApp button if it exists
    const existingWhatsAppButton = modal.querySelector('.whatsapp-button');
    if (existingWhatsAppButton) {
        existingWhatsAppButton.remove();
    }
}
 
function updateOrderModal(message, isSuccess, orderId) {
    const spinner = document.getElementById('order-loading-spinner');
    const responseMessage = document.getElementById('order-response-message');
    const okButton = document.getElementById('order-ok-button');

    spinner.style.display = 'none';
    responseMessage.textContent = message;
    responseMessage.style.color = isSuccess ? 'green' : 'red';
    okButton.style.display = 'block';

    if (isSuccess && orderId) {
        showWhatsAppButton(orderId);
    }
}
 
function checkout(event) {
    event.preventDefault();

    const customerName = document.getElementById('customer-name').value;
    const customerEmail = document.getElementById('customer-email').value;
    const customerPhone = document.getElementById('customer-phone').value;

    if (!customerName || !customerEmail || !customerPhone) {
        alert('Nome, e-mail e telefone são obrigatórios para finalizar o pedido.');
        return;
    }

    const orderData = {
        customerName: customerName,
        customerEmail: customerEmail,
        items: cart,
        totalAmount: cart.reduce((total, item) => total + item.price, 0)
    };

    showOrderModal();
    sendOrderToGoogleAppsScript(orderData);
}
 
async function sendOrderToGoogleAppsScript(orderData) {
    try {
        const formData = new FormData();
        formData.append('name', orderData.customerName);
        formData.append('email', orderData.customerEmail);
        formData.append('phone', document.getElementById('customer-phone').value);
        formData.append('instagram', document.getElementById('customer-instagram').value);
        formData.append('notes', document.getElementById('customer-notes').value);
        formData.append('total', orderData.totalAmount.toFixed(2));
        formData.append('items', JSON.stringify(orderData.items.map(item => ({
            platform: item.platform,
            service: item.service,
            quantity: item.quantity,
            price: item.price.toFixed(2)
        }))));

        const response = await fetch('https://script.google.com/macros/s/AKfycbwlF6aPwYAp-PTaHBvIypiiASPJC1OfBd7SQeNdLcwmz7zgpL_yUdWGQO0QMBXo6aTs/exec', {
            method: 'POST',
            body: formData,
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();

        if (result.result === 'success') {
            updateOrderModal('Pedido enviado com sucesso!', true, result.orderId);
            cart = [];
            updateCartDisplay();
            closeCheckoutModal();
            clearCheckoutForm();
        } else {
            throw new Error(result.message || 'Erro desconhecido ao processar o pedido.');
        }
    } catch (error) {
        console.error('Erro:', error);
        updateOrderModal('Erro ao enviar o pedido. Por favor, tente novamente. Se o problema persistir, entre em contato conosco.', false);
    }
}

function showWhatsAppButton(orderId) {
    const whatsappButton = document.createElement('a');
    whatsappButton.href = `https://wa.me/5583987084236?text=${encodeURIComponent(`Olá! Acabei de fazer um pedido (ID: ${orderId}) no site Crescer Redes Sociais. Gostaria de confirmar meu pedido.`)}`;
    whatsappButton.target = '_blank';
    whatsappButton.className = 'whatsapp-button';
    whatsappButton.textContent = 'Confirmar Pedido via WhatsApp';
    
    const orderModal = document.getElementById('order-modal');
    const modalContent = orderModal.querySelector('.modal-content');
    modalContent.appendChild(whatsappButton);
}


 document.addEventListener('DOMContentLoaded', () => {
     const platformSelect = document.getElementById('platform-select');
     const container = document.getElementById('social-media-cards');
     const checkoutModal = document.getElementById('checkout-modal');
     const closeCheckoutModalBtn = checkoutModal.querySelector('.close');
     const checkoutForm = document.getElementById('checkout-form');
     const checkoutButton = document.getElementById('checkout-button');
 
     const orderModal = document.getElementById('order-modal');
     const closeOrderModalBtn = document.getElementById('close-order-modal');
     const orderOkButton = document.getElementById('order-ok-button');
 
     platformSelect.addEventListener('change', (e) => {
         const selectedPlatform = e.target.value;
         container.innerHTML = ''; // Clear previous card
 
         if (selectedPlatform) {
             const platform = socialMediaPlatforms.find(p => p.name === selectedPlatform);
             if (platform) {
                 container.appendChild(createCard(platform));
             }
         }
     });
 
     closeCheckoutModalBtn.addEventListener('click', closeCheckoutModal);
     closeOrderModalBtn.addEventListener('click', () => {
         orderModal.style.display = 'none';
     });
 
     orderOkButton.addEventListener('click', () => {
         orderModal.style.display = 'none';
     });
 
     window.addEventListener('click', (event) => {
         if (event.target === checkoutModal) {
             closeCheckoutModal();
         }
         if (event.target === orderModal) {
             orderModal.style.display = 'none';
         }
     });
 
     checkoutForm.addEventListener('submit', checkout);
     checkoutButton.addEventListener('click', openCheckoutModal);
 
     updateCartDisplay();
 });